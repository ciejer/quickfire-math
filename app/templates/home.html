{% extends "base.html" %}
{% block content %}
<div class="layout">
  <section class="main-col">
    <div class="row space-between">
      <h1 class="title">Kia ora, {{ user.display_name }}</h1>
      <a class="muted-link" href="/">← Back</a>
    </div>

    <!-- Choose a drill (always 20 Qs) -->
    <form method="post" action="/start" class="chooser" id="choose-form">
      <label>Choose a drill</label>
      <div class="op-cards">
        {% if st.add_enabled %}<label class="op-card"><input type="radio" name="drill_type" value="addition" required><span>Addition</span></label>{% endif %}
        {% if st.sub_enabled %}<label class="op-card"><input type="radio" name="drill_type" value="subtraction" required><span>Subtraction</span></label>{% endif %}
        {% if st.mul_enabled %}<label class="op-card"><input type="radio" name="drill_type" value="multiplication" required><span>Multiplication</span></label>{% endif %}
        {% if st.div_enabled %}<label class="op-card"><input type="radio" name="drill_type" value="division" required><span>Division</span></label>{% endif %}
      </div>
      <button class="primary">Start</button>
    </form>

    <!-- Your settings (inline) -->
    <h2>Your settings</h2>
    <form id="settings-form" class="grid">
      <input type="hidden" name="user_id" value="{{ user.id }}">

      <fieldset>
        <legend>Addition</legend>
        <label><input type="checkbox" name="add_enabled" {% if st.add_enabled %}checked{% endif %}> Enabled</label>
        <div class="row">
          <label>Smallest number <input type="number" name="add_min" value="{{ st.add_min }}"></label>
          <label>Largest number <input type="number" name="add_max" value="{{ st.add_max }}"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>Subtraction</legend>
        <label><input type="checkbox" name="sub_enabled" {% if st.sub_enabled %}checked{% endif %}> Enabled</label>
        <div class="row">
          <label>Smallest number <input type="number" name="sub_min" value="{{ st.sub_min }}"></label>
          <label>Largest number <input type="number" name="sub_max" value="{{ st.sub_max }}"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>Multiplication</legend>
        <label><input type="checkbox" name="mul_enabled" {% if st.mul_enabled %}checked{% endif %}> Enabled</label>
        <div class="row">
          <label>First factor min <input type="number" name="mul_a_min" value="{{ st.mul_a_min }}"></label>
          <label>First factor max <input type="number" name="mul_a_max" value="{{ st.mul_a_max }}"></label>
        </div>
        <div class="row">
          <label>Second factor min <input type="number" name="mul_b_min" value="{{ st.mul_b_min }}"></label>
          <label>Second factor max <input type="number" name="mul_b_max" value="{{ st.mul_b_max }}"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>Division</legend>
        <label><input type="checkbox" name="div_enabled" {% if st.div_enabled %}checked{% endif %}> Enabled</label>
        <div class="row">
          <label>Quotient min <input type="number" name="div_q_min" value="{{ st.div_q_min }}"></label>
          <label>Quotient max <input type="number" name="div_q_max" value="{{ st.div_q_max }}"></label>
        </div>
        <div class="row">
          <label>Divisor min <input type="number" name="div_divisor_min" value="{{ st.div_divisor_min }}"></label>
          <label>Divisor max <input type="number" name="div_divisor_max" value="{{ st.div_divisor_max }}"></label>
        </div>
      </fieldset>

      <div class="row right">
        <button class="primary" type="button" id="save-settings">Save</button>
        <span id="save-msg" class="note"></span>
      </div>
    </form>

    <!-- Performance -->
    <h2>Recent performance</h2>
    <h3>Multiplication</h3>
    <div id="report-mul" class="heatmap"></div>
    <h3>Addition (0–20)</h3>
    <div id="report-add" class="heatmap"></div>
    <h3>Subtraction (0–20, larger − smaller)</h3>
    <div id="report-sub" class="heatmap"></div>
  </section>

  <aside class="news-col">
    <div class="stats-head">Drills finished today</div>
    <ul id="stats-list" class="stats-list">
      <li>Total: <strong>0</strong></li>
      <li>Addition: <strong>0</strong></li>
      <li>Subtraction: <strong>0</strong></li>
      <li>Multiplication: <strong>0</strong></li>
      <li>Division: <strong>0</strong></li>
    </ul>

    <div class="news-head">Your newsfeed</div>
    <div id="feed-list">
      {% if drills %}
        {% for d in drills %}
        <div class="news-item">
          <div class="news-time">{{ d.created_at.strftime("%A %I:%M %p") }}</div>
          <div class="news-settings">{{ d.settings_snapshot }}</div>
          <div class="news-result">{{ (d.elapsed_ms//60000) }} min {{ ((d.elapsed_ms//1000)%60) }} secs</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="news-empty">No drills yet — hit Start.</div>
      {% endif %}
    </div>
  </aside>

  <script>
    // Save settings via fetch to surface validation messages
    document.getElementById('save-settings').addEventListener('click', async () => {
      const form = document.getElementById('settings-form');
      const msg = document.getElementById('save-msg');
      const fd = new FormData(form);
      const res = await fetch('/settings/update', { method: 'POST', body: fd });
      if (res.ok) { msg.textContent = 'Saved!'; setTimeout(()=>msg.textContent='', 2000); }
      else { msg.textContent = await res.text(); }
    });
  </script>
</div>
{% endblock %}
